<!DOCTYPE html>
<html lang="en">
	<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Thirteen</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jquery.Jcrop.css" type="text/css" />

    <style>
    	.file-box {
    		text-align: center; overflow: hidden; width: 400px; height: 400px; border: 1px solid #99cccc; background: #99cccc url(/css/upload.png) no-repeat;
    	}

    	.uploadForm {
			width: 40%;
			margin-left: auto;
			margin-right: auto;
		}
	</style>
	</head>
	<body>
	<!-- navigation top bar -->
	<nav class="navbar navbar-default" role="navigation">
		<div class="container-fluid">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">Thirteen</a>
			</div>
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	      		<ul class="nav navbar-nav">
	        		<li><a href="/">Home</a></li>
	        		<li class="active"><a href="#">Upload</a></li>
	      		</ul>
	    	</div>
		</div><!-- /.container-fluid -->
	</nav>

    <div class="container" style="margin-top: 100px;">
		<div class="uploadForm">
			<div id="uForm">
				<form role="form" id="uploadForm" onsubmit="return false;" enctype="multipart/form-data" method="post">
					<div class="form-group">
						<div class="file-box">
							<input type="file" id="uploadFile" multiple="multiple" style="margin-top: 0px; margin-left: 0px; -moz-opacity: 0; filter: alpha(opacity=0); opacity: 0; font-size: 150px; width: 400px; height: 400px;" />
						</div>
					</div>
				</form>
		    </div>
		    <div id="uProgress" style="display: none;">
		    <label id="fileName"></label>
				<div class="progress">
					<div id="progBar" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
				    	<span class="sr-only"></span>
					</div>
				</div>
		    </div>
		    <div id="uCrop" style="display: none;">
		    	<div class="row">
		    		<div class="col-lg-8">
		    			<img class="img-responsive" id="uLoaded" src="" />
		    			<img class="img-responsive hidden" id="uLoaded2" src="" />
		    		</div>
		    		<div class="col-lg-4">
		    			<div class="form-group">
							<label for="fileDesc">Description</label>
							<input type="text" class="form-control" id="description" placeholder="Description" />
						</div>
						<div class="form-group">
							<label for="fileTags">Tags</label>
							<input type="text" class="form-control" id="tags" placeholder="Tags" />
						</div>

						<button id="uploadInfo" class="btn btn-default">Upload</button>
		    		</div>
		    	</div>    	
		    </div>
		</div>
    </div>

    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
	<script src="/js/cookie.js"></script>
	<script src="/js/jquery.jcrop.js"></script>
	<script>

	$(function() {

		var x = 0;
		var y = 0;
		var w = 0;
		var h = 0;
		var width = 0;
		var height = 0;
		var id = 0;

		var jcrop;

		$("#uploadFile").on('change', function() {
			var file = document.getElementById('uploadFile').files[0];
	        var data = new FormData();
	        data.append('uploadFile', file);

			if (!file.type.match(/image/)) {
				$("#uploadFile").val('');
				return;
			}

			x = 0;
			y = 0;
			w = 0;
			h = 0;

			$("fileName").text('Uploading ' + file.name);

		    $.ajax( {
		    	url: '/api/images/upload', 
		    	type: "POST",
		    	data: data,
		    	cache: false,
		    	enctype: "multipart/form-data",
		    	processData: false,
		    	contentType: false,
		    	success: function(data) {
		    		data = JSON.parse(data);
		    		id = data.id;
		    		setTimeout(function(){
		    			$("#uProgress").fadeOut();
		    			setTimeout(function(){
		    				console.log(data);
		    				$("#uLoaded").attr('src', data.path);
							$("#uCrop").fadeIn();
							$('#uLoaded').Jcrop({
								minSize: [250, 250],
								maxSize: [1024, 1024],
								setSelect:   [ 0, 0, 250, 250 ],
								aspectRatio: 1,
								bgOpacity: 0.4,
      							bgColor: 'white',
      							onSelect: function(c) {
      								x = c.x;
      								y = c.y;
      								w = c.w;
      								h = c.h;
      							},
      							onChange: function(c) {
      								x = c.x;
      								y = c.y;
      								w = c.w;
      								h = c.h;
      							}
							}, function() { jcrop = this; });
						}, 500);
		    		}, 1000);
				},
				xhr: function() {
	                var xhr = $.ajaxSettings.xhr();

	                if ( xhr.upload ) {
	                	setTimeout(function(){
						$("#uForm").fadeOut();
							setTimeout(function(){
								$("#uProgress").fadeIn();
							}, 500);
						}, 500);
						xhr.upload.onprogress = function(e) {
	                       	file.progressDone = e.position || e.loaded;
	                       	file.progressTotal = e.totalSize || e.total;
	                       	$("#progBar").css('width', (100 * file.progressDone / file.progressTotal).toFixed(0) + '%');
	                   	};
	                }
	                return xhr;
	            }
			}).fail(function(data, err, status) {
				if (status == 'Forbidden') document.location.href = '/html/login.html';
			});

		});

		$("#uploadInfo").on('click', function() {
			var desc = $("#description").val();
			var tags = $("#tags").val();

			var uLoaded = $("#uLoaded");

			width = uLoaded.css('width').replace('px','');
			realWidth = uLoaded[0].naturalWidth;
			var enlarge = realWidth /  width;
			
			console.log(realWidth, width, enlarge);

			$.post("/api/images/update/" + id, { 
				desc: desc, 
				tags: tags, 
				x: x * enlarge, 
				y: y * enlarge,
				size: w * enlarge, 
			}, function(data)  {
				data = JSON.parse(data);
				$("#uLoaded").remove();
				jcrop.destroy();
				$("#uLoaded2").attr('src', data.path).removeClass("hidden");
			}).fail(function(data) {
				$("#loginStatus").hide();
				$("#loginLogin").val('');
				$("#loginPassword").val('');
				$("#loginForm").show();
				$("#failForm").show();
				try {
					data = JSON.parse(data.responseText);			
					console.log("Error: " + data.message);
				} catch (e) {

				}
			});
		});
	});
	</script>
  </body>
</html>